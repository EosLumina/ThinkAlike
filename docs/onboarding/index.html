<script>
    $(document).ready(function() {
        const markdownFilePath = 'ONBOARDING_GUIDE.md';
        const apiKey = 'YOUR_GOOGLE_TRANSLATE_API_KEY'; // Replace with your actual API key if needed
        const languageSelect = $('#languageSelect');

        const sectionIds = ['preamble', 'section1', 'section2', 'section3', 'section4', 'section5', 'section6', 'section7', 'section8', 'section9', 'section10', 'appendices', 'conclusion', 'manifesto'];
        const sections = {};
        let currentSection = 'preamble';

        fetch(markdownFilePath)
            .then(response => response.text())
            .then(markdownData => {
                const lines = markdownData.split('\n');

                for (const line of lines) {
                    if (line.startsWith('# ')) {
                        currentSection = 'preamble'; // Level 1 heading is "preamble"
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 1. ')) {
                        currentSection = 'section1';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 2. ')) {
                        currentSection = 'section2';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 3. ')) {
                        currentSection = 'section3';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 4. ')) {
                        currentSection = 'section4';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 5. ')) {
                        currentSection = 'section5';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 6. ')) {
                        currentSection = 'section6';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 7. ')) {
                        currentSection = 'section7';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 8. ')) {
                        currentSection = 'section8';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 9. ')) {
                        currentSection = 'section9';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## 10. ')) {
                        currentSection = 'section10';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## APPENDICES')) {
                        currentSection = 'appendices';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## CONCLUSION')) {
                        currentSection = 'conclusion';
                        sections[currentSection] = sections[currentSection] || [];
                    } else if (line.startsWith('## MANIFESTO')) {
                        currentSection = 'manifesto';
                        sections[currentSection] = sections[currentSection] || [];
                    }
                    if (currentSection) {
                        sections[currentSection].push(line);
                    }
                }

                function renderSection(sectionId, markdownContent) {
                    if (!markdownContent) {
                        console.warn("renderSection: markdownContent is falsy for sectionId:", sectionId);
                        return;
                    }
                    const htmlContent = markdownContent.join('\n');
                    $(`#${sectionId}`).html(marked.parse(htmlContent));
                }

                function translateManual(targetLanguage) {
                    sectionIds.forEach(sectionId => {
                        let textToTranslate = sections[sectionId].join('\n');
                        if (textToTranslate) {
                            $.ajax({
                                url: 'https://translation.googleapis.com/language/translate/v2',
                                method: 'POST',
                                data: {
                                    key: apiKey,
                                    q: textToTranslate,
                                    target: targetLanguage,
                                    format: 'text'
                                },
                                success: function(response) {
                                    if (response.data && response.data.translations && response.data.translations[0]) {
                                        const translatedText = response.data.translations[0].translatedText;
                                        renderSection(sectionId, translatedText.split('\n'));
                                    } else {
                                        alert('Translation failed for section: ' + sectionId);
                                    }
                                },
                                error: function(error) {
                                    alert('Error during translation for section ' + sectionId + ': ' + error.statusText);
                                }
                            });
                        }
                    });
                }

                renderSection('preamble', sections['preamble']);

                $('.nav-link').click(function(e) {
                    e.preventDefault();
                    $('.nav-link').removeClass('active');
                    $(this).addClass('active');

                    const sectionId = $(this).data('section');
                    $('.section-content').hide();
                    $(`#${sectionId}`).show();

                    if (sections[sectionId]) {
                        renderSection(sectionId, sections[sectionId]);
                    } else if (sectionId === 'manifesto') {
                        renderSection(sectionId, sections['manifesto']);
                    } else {
                        $(`#${sectionId}`).html('<p>Section content loading...</p>');
                    }
                });

                languageSelect.change(function() {
                    const targetLanguage = $(this).val();
                    if (targetLanguage !== 'en') {
                        translateManual(targetLanguage);
                    } else {
                        sectionIds.forEach(sectionId => {
                            renderSection(sectionId, sections[sectionId]);
                        });
                    }
                });

                $('.section-content').hide();
                $('#preamble').show();

            })
            .catch(error => {
                console.error("Error fetching markdown file:", error);
            });
    });
</script>

